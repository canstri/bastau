{% extends "base.html" %}
{% load urlify %}
{% load crispy_forms_tags %}

{% block head_title %}
{{ instance.title }} | {{ block.super }}
{% endblock head_title %}


{% block content %}


<div class='ui container'>
    <div class="ui list">
        <a class="button ui blue" href='{% url "news:list" %}'>
            <i class="arrow left icon"></i> Back to list
        </a>

        {% if staff == "yes" %}
        <span>
            Staff only: <a class="button ui tiny" href='{% url "news:create" %}'>Create another post</a>
        </span>
        <a href='{{ instance.get_update_url }}' class="button ui tiny">Edit</a>
        <a href='{{ instance.get_delete_url }}' class="button ui tiny">Delete</a>
        {% endif %}

        <div class="ui grid" style="margin-top:20px">
            <div class="twelve wide column">
                <a href="{{ instance.get_author }}">{{ instance.user.username }}</a>({{ instance.publish }})
                <h1 style="margin-top: 10px;">{{ title }}</h1>
                {{ instance.get_markdown }}
                {% if instance.image %}
                <img class="responsive-img" src='{{ instance.image.url }}'/>
                {% endif %}
            </div>
        </div>


        <div class="ui  threaded comments">
            {% if is_auth == False %}
            <h3>
                Please, <a href='{% url "login" %}'>login</a> to comment other users.
            </h3>
            {% endif %}
            <h3 class="ui dividing header">
                {{ comments.count }} Comment{% if comments.count > 1 or comments.count == 0 %}s{% endif %}
            </h3>
            {% for comment in comments_parents %}

            <div class="comment" id="comments">

                {% if comment.author.image %}

                <a class="avatar" href="{{ comment.get_profile }}">
                    <img src="{{ comment.author.image.url }}" class="user_img_comments">
                </a>
                {% endif %}



                <div class="content">

                    <a href="{{ comment.get_profile }}" class="author">
                        {{ comment.user }}
                    </a>

                    <div class="metadata">
                            <span class="date">
                                {{ comment.timestamp|timesince }} ago
                            </span>
                        <div class="meta">
                            <a class="like">
                                <i class="like icon"></i> 4 Likes
                            </a>
                        </div>
                    </div>

                    <div class="text">
                        {{ comment.content }}
                    </div>

                    <div class="actions">
                        {% if is_auth == True %}
                        <a class="reply reply-me">Reply</a>
                        {% endif %}
                        {% if request.user == comment.user or staff == "yes" %}
                        <a href='{{ comment.get_delete_url }}' class="reply">Delete</a>
                        {% endif %}
                    </div>


                </div>
            </div>
            {% if is_auth == True %}
            <form class="ui reply form hide-me" method="POST" action="." enctype="multipart/form-data">
                {% csrf_token %}
                {{ comment_form }}
                <div class="field">
                    <input type='hidden' name='parent_id' value='{{ comment.id }}'>
                </div>
                <input type='submit' value='Add Reply' class='ui blue submit icon button '>
            </form>
            {% endif %}

            {% for child_comment in comment.children %}

            <div class="comments" id="reply-comments">
                <div class="comment">

                {% if child_comment.author.image %}
                    <a href="{{ child_comment.get_profile }}" class="avatar">
                        <img class="user_img_comments" src="{{ child_comment.author.image.url }}">
                    </a>
                {% endif %}

                    <div class="content">
                        <a href="{{ child_comment.get_profile }}" class="author">{{ child_comment.user }}</a>
                        <div class="metadata">
                            <span class="date">{{ child_comment.timestamp|timesince }} ago</span>
                        </div>
                        <div class="text">{{ child_comment.content }}</div>
                        <div class="actions">
                            {% if is_auth == True %}
                            <a class='comment-children-reply-btn reply reply-me' href='#'>
                                Reply
                            </a>
                            {% endif %}
                            {% if request.user == child_comment.user or staff == "yes"%}
                            <a href='{{ child_comment.get_delete_url }}'>Delete</a>
                            {% endif %}
                        </div>

                    </div>

                    {% if is_auth == True %}
                    <div class='comment-reply ui reply form asd hide-me'>
                        <form method="POST" action=".">
                            <div class="field">
                                {% csrf_token %}
                                {{ comment_form }}
                                <input type='hidden' name='parent_id' value='{{ comment.id }}'>

                            </div>

                            <input type='submit' value='Add Reply' class='ui blue submit icon button '>
                        </form>
                    </div>
                    {% endif %}



                </div>

            </div>
            {% endfor %}



            {% endfor %}


        </div>
        {% if is_auth == True %}
        <form class="comment_form ui reply form" method="POST" action='' enctype='multipart/form-data'>
            <div class="field" id="write-comment">
                {% csrf_token %}
                {{ comment_form }}
            </div>

            <input type='submit' class='ui button blue submit' value='Post comment'>
        </form>
        {% endif %}

    </div>


</div>


{% endblock content %}